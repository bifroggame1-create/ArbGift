version: "3.9"

# Full stack deployment with all services
# Usage: docker-compose -f docker-compose.full.yml up -d

services:
  # ===========================================
  # INFRASTRUCTURE
  # ===========================================

  postgres:
    image: postgres:16-alpine
    container_name: ton-gifts-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ton_gifts
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ton-gifts-network

  redis:
    image: redis:7-alpine
    container_name: ton-gifts-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ton-gifts-network

  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: ton-gifts-meilisearch
    environment:
      MEILI_ENV: production
      MEILI_MASTER_KEY: ${MEILISEARCH_API_KEY}
      MEILI_NO_ANALYTICS: true
    ports:
      - "7700:7700"
    volumes:
      - meilisearch_data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ton-gifts-network

  # ===========================================
  # MAIN API (Gift Aggregator)
  # ===========================================

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ton-gifts-api
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ton_gifts
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
      MEILISEARCH_URL: http://meilisearch:7700
      MEILISEARCH_API_KEY: ${MEILISEARCH_API_KEY}
      TONAPI_KEY: ${TONAPI_KEY}
      DEBUG: "false"
      LOG_LEVEL: INFO
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    restart: unless-stopped
    networks:
      - ton-gifts-network

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ton-gifts-celery-worker
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ton_gifts
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
      TONAPI_KEY: ${TONAPI_KEY}
    depends_on:
      - postgres
      - redis
    command: celery -A app.workers.celery_app worker --loglevel=info --concurrency=4 -Q default,indexer,sync,metadata
    restart: unless-stopped
    networks:
      - ton-gifts-network

  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ton-gifts-celery-beat
    environment:
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
    depends_on:
      - redis
      - celery-worker
    command: celery -A app.workers.celery_app beat --loglevel=info
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # AVIATOR CRASH GAME
  # ===========================================

  aviator-api:
    build:
      context: ./services/aviator
      dockerfile: Dockerfile
    container_name: ton-gifts-aviator
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/aviator
      REDIS_URL: redis://redis:6379/3
      SECRET_KEY: ${AVIATOR_SECRET_KEY}
    ports:
      - "8001:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # ROULETTE GAME
  # ===========================================

  roulette-api:
    build:
      context: ./services/roulette
      dockerfile: Dockerfile
    container_name: ton-gifts-roulette
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/roulette
      REDIS_URL: redis://redis:6379/4
      SECRET_KEY: ${ROULETTE_SECRET_KEY}
    ports:
      - "8002:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # STARS PURCHASE SERVICE
  # ===========================================

  stars-api:
    build:
      context: ./services/stars
      dockerfile: Dockerfile
    container_name: ton-gifts-stars
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/stars
      REDIS_URL: redis://redis:6379/5
      BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TONAPI_KEY: ${TONAPI_KEY}
    ports:
      - "8003:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # CONTRACTS GAME SERVICE
  # ===========================================

  contracts-api:
    build:
      context: ./services/contracts
      dockerfile: Dockerfile
    container_name: ton-gifts-contracts
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/contracts
      REDIS_URL: redis://redis:6379/6
      DEBUG: ${DEBUG:-false}
      JWT_SECRET_KEY: ${CONTRACTS_SECRET_KEY:-change-me-in-production}
    ports:
      - "8004:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # UPGRADE GAME SERVICE
  # ===========================================

  upgrade-api:
    build:
      context: ./services/upgrade
      dockerfile: Dockerfile
    container_name: ton-gifts-upgrade
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/upgrade
      REDIS_URL: redis://redis:6379/7
      DEBUG: ${DEBUG:-false}
      JWT_SECRET_KEY: ${UPGRADE_SECRET_KEY:-change-me-in-production}
    ports:
      - "8005:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # TRADING/CRASH GAME SERVICE
  # ===========================================

  trading-api:
    build:
      context: ./services/trading
      dockerfile: Dockerfile
    container_name: ton-gifts-trading
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/trading
      REDIS_URL: redis://redis:6379/8
      DEBUG: ${DEBUG:-false}
      SECRET_KEY: ${TRADING_SECRET_KEY:-change-me-in-production}
    ports:
      - "8006:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # PLINKO GAME SERVICE
  # ===========================================

  plinko-api:
    build:
      context: ./services/plinko
      dockerfile: Dockerfile
    container_name: ton-gifts-plinko
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/plinko
      REDIS_URL: redis://redis:6379/9
      DEBUG: ${DEBUG:-false}
      SECRET_KEY: ${PLINKO_SECRET_KEY:-change-me-in-production}
    ports:
      - "8007:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # SOLO GAMES SERVICE (Gonka, Ball Escape, etc)
  # ===========================================

  solo-games-api:
    build:
      context: ./services/solo-games
      dockerfile: Dockerfile
    container_name: ton-gifts-solo-games
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/solo_games
      REDIS_URL: redis://redis:6379/10
      DEBUG: ${DEBUG:-false}
      SECRET_KEY: ${SOLO_GAMES_SECRET_KEY:-change-me-in-production}
    ports:
      - "8008:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # PVP GIFT ROULETTE SERVICE (Rolls.codes clone)
  # ===========================================

  pvp-api:
    build:
      context: ./services/pvp
      dockerfile: Dockerfile
    container_name: ton-gifts-pvp
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/pvp
      REDIS_URL: redis://redis:6379/11
      DEBUG: ${DEBUG:-false}
      JWT_SECRET_KEY: ${PVP_SECRET_KEY:-change-me-in-production}
    ports:
      - "8009:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # STAKING SERVICE
  # ===========================================

  staking-api:
    build:
      context: ./services/staking
      dockerfile: Dockerfile
    container_name: ton-gifts-staking
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/staking
      REDIS_URL: redis://redis:6379/12
      DEBUG: ${DEBUG:-false}
      JWT_SECRET_KEY: ${STAKING_SECRET_KEY:-change-me-in-production}
    ports:
      - "8010:8000"
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # FRONTEND (Telegram Mini App)
  # ===========================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ton-gifts-frontend
    environment:
      VITE_API_URL: ${API_URL:-http://localhost:8000}
      VITE_WS_URL: ${WS_URL:-ws://localhost:8000}
      VITE_AVIATOR_URL: ${AVIATOR_URL:-http://localhost:8001}
      VITE_ROULETTE_URL: ${ROULETTE_URL:-http://localhost:8002}
    ports:
      - "3000:80"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - ton-gifts-network

  # ===========================================
  # NGINX REVERSE PROXY
  # ===========================================

  nginx:
    image: nginx:alpine
    container_name: ton-gifts-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
      - frontend
      - aviator-api
      - roulette-api
      - stars-api
      - contracts-api
      - upgrade-api
      - trading-api
      - plinko-api
      - solo-games-api
    restart: unless-stopped
    networks:
      - ton-gifts-network

volumes:
  postgres_data:
  redis_data:
  meilisearch_data:

networks:
  ton-gifts-network:
    driver: bridge
